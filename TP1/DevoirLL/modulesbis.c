#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "types.h"


int main(int argc, char **argv) {
  
  int memsize = 30;
  instr *ram = (instr *)malloc(memsize * sizeof(instr));
  int pos = 0;
  instr vide = {"","empty",0,NULL};
  
  for (int i=0;i<memsize;i++){
    ram[i] = vide;
  }
  union value empty;
  union value val1; //constante 0
  val1.n = 0;
  instr instr0 = newinstr("fac","pop",1,1,0,val1,0,0,empty);

  union value val2; //constante 1
  val2.n = 1;
  instr instr1 = newinstr("","cmp",2,1,0,val1,0,0,val2);

  union value val3;
  strcpy(val3.name,"fin");
  
  instr instr2 = newinstr("","jeq",1,3,1,val3,0,0,empty);
  
  instr instr3 = newinstr("","push",1,1,0,val1,0,0,empty);

  instr instr4 = newinstr("","dec",1,1,0,val1,0,0,empty);
///remplacement call
  union value val4;
  strcpy(val4.name,"fac");
  //instr instr5 = newinstr("","call",2,3,1,val4,1,0,val1);

  union value valRetour;
    strcpy(valRetour.name,"rFa");
    instr instr5a = newinstr("","push",1,3,1,valRetour,0,0,empty);
    instr instr5b = newinstr("","push",1,1,0,val1,0,0,empty);
    instr instr5c = newinstr("","jmp",1,3,1,val4,0,0,empty);
  ///fin remplacement
  instr instr6 = newinstr("rFa","pop",1,1,0,val2,0,0,empty);

  instr instr7 = newinstr("","pop",1,1,0,val1,0,0,empty);
 
  instr instr8 = newinstr("","mul",2,1,0,val1,1,0,val2);
//remplacement retour

  //instr instr9 = newinstr("fin","ret",1,1,0,val1,0,0,empty);
  union value addrRetour;
  //addrRetour.n=0
    strcpy(addrRetour.name,"RE");
  instr instr9a = newinstr("fin","pop",1,1,1,addrRetour,0,0,empty);
  instr instr9b = newinstr("","push",1,1,0,val1,0,0,empty);
  instr instr9c = newinstr("","jmp",1,1,1,addrRetour,0,0,empty);
  //fin remplacement
  instr *listeinstr0 = (instr *)malloc(14 * sizeof(instr));
  listeinstr0[0] = instr0;
  listeinstr0[1] = instr1;
  listeinstr0[2] = instr2;
  listeinstr0[3] = instr3;
  listeinstr0[4] = instr4;
  //
    listeinstr0[5] = instr5a;
    listeinstr0[6] = instr5b;
    listeinstr0[7] = instr5c;
  //
  listeinstr0[8] = instr6;
  listeinstr0[9] = instr7;
  listeinstr0[10] = instr8;
  //
    listeinstr0[11] = instr9a;
    listeinstr0[12] = instr9b;
    listeinstr0[13] = instr9c;
  //
  module modex0 = newmod(14,listeinstr0);

  union value val5; //constante 3
  val5.n = 3;
  instr instr10 = newinstr("deb","push",1,0,0,val5,0,0,empty);

  union value val7; //constante 2
  val7.n = 2; 
  instr instr11 = newinstr("","pop",1,1,0,val7,0,0,empty);
  
  union value val6; //constante 6
  val6.n = 6;
  instr instr12 = newinstr("","push",1,0,0,val6,0,0,empty);

  union value val8; //constante 3
  val8.n = 3;  
  instr instr13 = newinstr("","pop",1,1,0,val8,0,0,empty);

  //remplacement call
  //instr instr14 = newinstr("","call",2,3,1,val4,1,0,val7);
    union value valRetour2;
    strcpy(valRetour2.name,"Ma1");
    instr instr14a = newinstr("","push",1,3,1,valRetour2,0,0,empty);
    instr instr14b = newinstr("","push",1,1,0,val7,0,0,empty);
    instr instr14c = newinstr("","jmp",1,3,1,val4,0,0,empty);
//deuxieme remplacement call
  //instr instr15 = newinstr("","call",2,3,1,val4,1,0,val8);
    union value valRetour3;
    strcpy(valRetour3.name,"Ma2");
    instr instr15a = newinstr("Ma1","push",1,3,1,valRetour3,0,0,empty);
    instr instr15b = newinstr("","push",1,1,0,val8,0,0,empty);
    instr instr15c = newinstr("","jmp",1,3,1,val4,0,0,empty);
  //fin remplacement call
  instr instr16 = newinstr("Ma2","pop",1,1,0,val7,0,0,empty);

  instr instr17 = newinstr("","pop",1,1,0,val8,0,0,empty);
  
  instr instr18 = newinstr("","add",2,1,0,val7,1,0,val8);

  instr instr19 = newinstr("","prin",1,1,0,val7,0,0,empty);
  

  instr *listeinstr1 = (instr *)malloc(14 * sizeof(instr));
  listeinstr1[0] = instr10;
  listeinstr1[1] = instr11;
  listeinstr1[2] = instr12;
  listeinstr1[3] = instr13;
  //
    listeinstr1[4] = instr14a;
    listeinstr1[5] = instr14b;
    listeinstr1[6] = instr14c;
//
    listeinstr1[7] = instr15a;
    listeinstr1[8] = instr15b;
    listeinstr1[9] = instr15c;
//
listeinstr1[10] = instr16;
  listeinstr1[11] = instr17;
  listeinstr1[12] = instr18;
  listeinstr1[13] = instr19;
      
  module modex1 = newmod(14,listeinstr1);
 
  module modules[2]={modex0,modex1};

  //Création de la table des symboles
  List *table = init();

  printf("Modules avant édition de liens :\n");
  affichemem(modex1.size,modex1.listeinstr);
  affichemem(modex0.size,modex0.listeinstr);
  //affichemem(memsize,ram);
  
  module modlinked = linker(2,modules,table);
  printf("Module après édition de liens :\n");
  affichemem(modlinked.size,modlinked.listeinstr);
  
  pos = loader(pos,modlinked,ram);
  //affichemem(modex1.size,modex1.listeinstr);
  //affichemem(modex0.size,modex0.listeinstr);
  printf("Mémoire après chargement :\n");
  affichemem(memsize,ram);
  
  free(instr1.args);
  free(instr2.args);
  free(instr3.args);
  free(listeinstr0);
  free(listeinstr1);
  free(ram);

  return 0;
}



  
  
